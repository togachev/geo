{% extends 'base.html' %}
{% load static %}
{% block content %}

    <div id="map">
      <!-- Атрибуты -->
      <!-- <a href="http://mapbox.com/about/maps" class='mapbox-logo' target="_blank">Mapbox</a>
      <div class="mapbox-attribution-container">
        <a href="https://www.mapbox.com/about/maps/">© Mapbox | </a>
        <a href="http://www.openstreetmap.org/copyright">© OpenStreetMap | </a>
        <a href="https://www.mapbox.com/map-feedback/" target="_blank"><strong>Improve this map</strong></a>
      </div> -->

    </div>


    <script>

        mapboxgl.accessToken = '{{token|safe}}';
        // mapboxgl.workerCount = '{{workerCount|safe}}';


        var map = new mapboxgl.Map({
            container: 'map',
            antialias: 'true',
            attributionControl: 'true',
            zoom: 5,
            center: [70.538086, 62.201629],
            // 'pitch': 45,
            // 'bearing': 90,
            hash: 'true',
            optimize: 'true',

            style: {
                'version': 8,
                'sources': {
                    'carto-dark': {
                        'type': 'raster',
                        'tiles': [
                            "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                        ],
                        'tileSize': 256,
                    },
                    'forest-data': {
                        'attribution': '© Атрибуты',
                        'description': 'generated from postgis database',
                        'tilejson': '3.0.0',
                        'type': 'vector',
                        'tiles': [
                            'http://192.168.14.142/geo/layer/1/tile/{z}/{x}/{y}'
                        ],
                        'optimize': 'true',
                    },
                    // 'forest-data': {
                    //     'type': 'vector',
                    //     'tiles': [
                    //         'http://192.168.14.142/geo/layer/2/tile/{z}/{x}/{y}'
                    //     ]
                    // },
                    // 'forest-data': {
                    //     'type': 'vector',
                    //     'tiles': [
                    //         'http://192.168.14.142/geo/layer/3/tile/{z}/{x}/{y}'
                    //     ]
                    // }
                },
                "glyphs": "mapbox://fonts/mapbox/{fontstack}/{range}.pbf",
                'layers': [
                    {
                        'id': 'carto-dark-layer',
                        'type': 'raster',
                        'source': 'carto-dark',
                        'minResolution': 0,
                        'maxResolution': 22
                    },
                    {
                        'id': 'contour-les',
                        'type': 'fill',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        'minzoom': 0,
                        'maxzoom': 7,
                        'paint': {
                            // 'fill-outline-color': 'red',
                            // 'fill-color': 'red',
                            'fill-opacity': 0
                        },
                        "filter": [
                          "all",
                          ["==", "type_data", 1]
                        ]
                    },
                    {
                        'id': 'contour-uch-les',
                        'type': 'fill',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        'minzoom': 7,
                        'maxzoom': 9,
                        'paint': {
                            // 'fill-outline-color': 'blue',
                            // 'fill-color': 'blue',
                            'fill-opacity': 0
                        },
                        "filter": [
                          "all",
                          ["==", "type_data", 2]
                        ]
                    },
                    {
                        'id': 'contour-uroch',
                        'type': 'fill',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        'minzoom': 9,
                        'maxzoom': 10,
                        'paint': {
                            // 'fill-outline-color': 'green',
                            // 'fill-color': 'green',
                            'fill-opacity': 0
                        },
                        "filter": [
                          "all",
                          ["==", "type_data", 3]
                        ]
                    },
                    {
                        'id': 'kvartal-les',
                        'type': 'fill',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        'minzoom': 10,
                        'maxzoom': 12,
                        'paint': {
                            // 'fill-outline-color': 'red',
                            // 'fill-color': 'red',
                            'fill-opacity': 0
                        },
                        "filter": [
                          "all",
                          ["==", "type_data", 4]
                        ]
                    },
                    {
                        'id': 'vydel-les',
                        'type': 'fill',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        'minzoom': 12,
                        'maxzoom': 22,
                        'paint': {
                            // 'fill-outline-color': '#A40000',
                            // 'fill-color': '#A40000',
                            'fill-opacity': 0
                        },
                        "filter": [
                          "all",
                          ["==", "type_data", 5]
                        ]
                    },
                    {
                        'id': 'contour-data-stroke-les',
                        'type': 'line',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "paint": {
                          "line-color": "red",
                          "line-opacity": 1,
                          "line-width": 1,
                          //"line-dasharray": [4, 4],
                          "line-gap-width": 0
                        },
                        "layout": {
                          "line-cap": "butt",
                          "line-join": "bevel"
                        },
                        "minzoom": 0,
                        "maxzoom": 7,
                        "filter": [
                          "all",
                          ["==", "type_data", 1]
                        ]
                    },
                    {
                        'id': 'contour-data-stroke-uch-les',
                        'type': 'line',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "paint": {
                          "line-color": "blue",
                          "line-opacity": 1,
                          "line-width": 1,
                          //"line-dasharray": [4, 4],
                          "line-gap-width": 0
                        },
                        "layout": {
                          "line-cap": "butt",
                          "line-join": "bevel"
                        },
                        "minzoom": 7,
                        "maxzoom": 9,
                        "filter": [
                          "all",
                          ["==", "type_data", 2]
                        ]
                    },
                    {
                        'id': 'contour-data-stroke-uroch',
                        'type': 'line',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "paint": {
                          "line-color": "#4E9A06",
                          "line-opacity": 1,
                          "line-width": 1,
                          //"line-dasharray": [4, 4],
                          "line-gap-width": 0
                        },
                        "layout": {
                          "line-cap": "butt",
                          "line-join": "bevel"
                        },
                        "minzoom": 9,
                        "maxzoom": 10,
                        "filter": [
                          "all",
                          ["==", "type_data", 3]
                        ]
                    },
                    {
                        'id': 'contour-data-stroke-kvartal',
                        'type': 'line',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "paint": {
                          "line-color": "red",
                          "line-opacity": 1,
                          "line-width": 1,
                          //"line-dasharray": [4, 4],
                          "line-gap-width": 0
                        },
                        "layout": {
                          "line-cap": "butt",
                          "line-join": "bevel"
                        },
                        "minzoom": 10,
                        "maxzoom": 12,
                        "filter": [
                          "all",
                          ["==", "type_data", 4]
                        ]
                    },
                    {
                        'id': 'contour-data-stroke-vydel',
                        'type': 'line',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "paint": {
                          "line-color": "#A40000",
                          "line-opacity": 1,
                          "line-width": 1,
                          //"line-dasharray": [4, 4],
                          "line-gap-width": 0
                        },
                        "layout": {
                          "line-cap": "butt",
                          "line-join": "bevel"
                        },
                        "minzoom": 12,
                        "maxzoom": 22,
                        "filter": [
                          "all",
                          ["==", "type_data", 5]
                        ]
                    },
                    {
                        'id': 'contour-data-label-les',
                        'type': 'symbol',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "layout": {
                          "text-font": [
                            "Arial Unicode MS Regular"
                          ],
                          "text-size": {
                            "stops": [[14, 12], [16, 14]]
                          },
                          "text-max-width": {
                            "stops": [[14, 5], [16, 6]]
                          },
                          "text-field": "{les}",
                          "text-padding": 10,
                          "text-line-height": 1,
                          "text-optional": true,
                          "visibility": "visible"
                        },
                        "paint": {
                          "text-color": "black",
                          "text-halo-color": "rgba(255,255,255,0.8)",
                          "text-halo-width": 1
                        },
                        "filter": [
                          "all",
                          ["==", "name", "Лесничество"],
                          ["==", "type_data", 1]
                        ],
                        "minzoom": 5,
                        "maxzoom": 7,
                    },
                    {
                        'id': 'contour-data-label-uch-les',
                        'type': 'symbol',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "layout": {
                          "text-font": [
                            "Arial Unicode MS Regular"
                          ],
                          "text-size": {
                            "stops": [[14, 12], [16, 14]]
                          },
                          "text-max-width": {
                            "stops": [[14, 5], [16, 6]]
                          },
                          "text-field": "{les}\n{uch_les}\n{uroch}",
                          "text-padding": 10,
                          "text-line-height": 1,
                          "text-optional": true,
                          "visibility": "visible"
                        },
                        "paint": {
                          "text-color": "black",
                          "text-halo-color": "rgba(255,255,255,0.8)",
                          "text-halo-width": 1
                        },
                        "filter": [
                          "all",
                          ["==", "name", "Лесничество"],
                          ["==", "type_data", 2]
                        ],
                        "minzoom": 7,
                        "maxzoom": 9,
                    },
                    {
                        'id': 'contour-data-label-uroch',
                        'type': 'symbol',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "layout": {
                          "text-font": [
                            "Arial Unicode MS Regular"
                          ],
                          "text-size": {
                            "stops": [[14, 12], [16, 14]]
                          },
                          "text-max-width": {
                            "stops": [[14, 5], [16, 6]]
                          },
                          "text-field": "{les}\n{uch_les}\n{uroch}",
                          "text-padding": 10,
                          "text-line-height": 1,
                          "text-optional": true,
                          "visibility": "visible"
                        },
                        "paint": {
                          "text-color": "black",
                          "text-halo-color": "rgba(255,255,255,0.8)",
                          "text-halo-width": 1
                        },
                        "filter": [
                          "all",
                          ["==", "name", "Лесничество"],
                          ["==", "type_data", 3]
                        ],
                        "minzoom": 9,
                        "maxzoom": 10,
                    },
                    {
                        'id': 'contour-data-label-kvartal',
                        'type': 'symbol',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "layout": {
                          "text-font": [
                            "Arial Unicode MS Regular"
                          ],
                          "text-size": {
                            "stops": [[14, 12], [16, 14]]
                          },
                          "text-max-width": {
                            "stops": [[14, 5], [16, 6]]
                          },
                          "text-field": "{les}\n{uch_les}\n{uroch}\n{kvartal}",
                          "text-padding": 10,
                          "text-line-height": 1,
                          "text-optional": true,
                          "visibility": "visible"
                        },
                        "paint": {
                          "text-color": "black",
                          "text-halo-color": "rgba(255,255,255,0.8)",
                          "text-halo-width": 1
                        },
                        "filter": [
                          "all",
                          ["==", "name", "Лесничество"],
                          ["==", "type_data", 4]
                        ],
                        "minzoom": 10,
                        "maxzoom": 12,
                    },
                    {
                        'id': 'contour-data-label-vydel',
                        'type': 'symbol',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        "layout": {
                          "text-font": [
                            "Arial Unicode MS Regular"
                          ],
                          "text-size": {
                            "stops": [[14, 12], [16, 14]]
                          },
                          "text-max-width": {
                            "stops": [[14, 5], [16, 6]]
                          },
                          "text-field": "{les}\n{uch_les}\n{uroch}\n{kvartal}\n{vydel}",
                          "text-padding": 10,
                          "text-line-height": 1,
                          "text-optional": true,
                          "visibility": "visible"
                        },
                        "paint": {
                          "text-color": "black",
                          "text-halo-color": "rgba(255,255,255,0.8)",
                          "text-halo-width": 1
                        },
                        "filter": [
                          "all",
                          ["==", "name", "Лесничество"],
                          ["==", "type_data", 5]
                        ],
                        "minzoom": 12,
                        "maxzoom": 22,
                    },
                    {
                        'id': 'contour-data-highlighted',
                        'type': 'line',
                        'source': 'forest-data',
                        'source-layer': 'les_data',
                        'paint': {
                          "line-color": "#FCE94F",
                          "line-width": 2.5,
                        },
                        'filter': ['in', 'id', '']
                    }
                ]
            }
        });


        map.on('click', (e) => {

            // Установите `bbox` как область прямоугольника 5px вокруг точки, по которой щелкнули.
            const bbox = [
            [e.point.x - 5, e.point.y - 5],
            [e.point.x + 5, e.point.y + 5]
            ];
            // Find features intersecting the bounding box.
            const selectedFeatures = map.queryRenderedFeatures(bbox, {
            layers: ['contour-les', 'contour-uch-les', 'contour-uroch', 'kvartal-les', 'vydel-les'] // 'id'
            });
            const fips = selectedFeatures.map(
            (feature) => feature.properties.id
            );
            // Установить фильтр, соответствующий выбранным объектам по кодам FIPS
            // чтобы активировать слой 'countries-highlighted'.
            map.setFilter(['contour-data-highlighted'], ['in', 'id', ...fips]);
            // map.setFilter(['kvartal-highlighted'], ['in', 'id', ...fips]);
            // map.setFilter(['vydel-highlighted'], ['in', 'id', ...fips]);
        });

        map.on('click', ['contour-les', 'contour-uch-les', 'contour-uroch', 'kvartal-les', 'vydel-les'], (e) => {
          const feature = e.features[0];

          data = feature.properties;
          delete data['id'];
          delete data['type_data'];
          var table = "<table>";
          for (let key in data) {
            table += `<tr><td>${key}</td><td>${data[key]}</td></tr>`;
          }
          table += "</table>";
          new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(
            '<div>'
              + table
              + 'Координаты: ' + Number((e.lngLat.lng).toFixed(6)) + ', ' + Number((e.lngLat.lat).toFixed(6)) +
            '</div>'
            )
          .addTo(map);
        // }

        });

        map.on('mouseenter', ['contour-les', 'contour-uch-les', 'contour-uroch', 'kvartal-les', 'vydel-les'], () => {
        map.getCanvas().style.cursor = 'pointer';
        });

        map.on('mouseleave', ['contour-les', 'contour-uch-les', 'contour-uroch', 'kvartal-les', 'vydel-les'], () => {
        map.getCanvas().style.cursor = '';
        });
        map.addControl(new mapboxgl.NavigationControl());
        const scale = new mapboxgl.ScaleControl({
        maxWidth: 100,
        unit: 'imperial'
        });
        map.addControl(scale);
        map.scrollZoom.setWheelZoomRate(1);
        map.resetNorthPitch({duration: 200});
        scale.setUnit('metric');

    </script>
{% endblock %}
